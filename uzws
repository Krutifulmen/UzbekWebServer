#!/bin/bash

# Uzbek Web Server (UzWS) - –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–∞ Bash
# –í–µ—Ä—Å–∏—è 2.0 "Plov Edition" üá∫üáø

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# –ì–∞–ª–æ—á–∫–∏ –∏ —Å–∏–º–≤–æ–ª—ã
CHECK="‚úÖ"
INFO="üî∑"
WARN="üî∂"
ERROR="üî¥"
SERVER="üöÄ"

# –§—É–Ω–∫—Ü–∏—è –ø–æ–º–æ—â–∏
show_help() {
    echo -e "${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë          Uzbek Web Server (UzWS) - –ü–æ–º–æ—â—å               ‚ïë"
    echo "‚ïë                 –í–µ—Ä—Å–∏—è 2.0 'Plov Edition'               ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}${BOLD}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:${NC}"
    echo "  uzws [–ø–æ—Ä—Ç] [–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è]  ${CHECK} –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"
    echo "  uzws --help               ${CHECK} –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo "  uzws -h                   ${CHECK} –¢–æ –∂–µ —Å–∞–º–æ–µ"
    echo "  uzws --version            ${CHECK} –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é"
    echo "  uzws -v                   ${CHECK} –¢–æ –∂–µ —Å–∞–º–æ–µ"
    echo "  uzbekwebserver            ${CHECK} –ê–ª–∏–∞—Å –¥–ª—è uzws"
    echo ""
    echo -e "${CYAN}${BOLD}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
    echo "  uzws 8080 ./public        ${CHECK} –ü–æ—Ä—Ç 8080, –ø–∞–ø–∫–∞ public"
    echo "  uzws 3000                 ${CHECK} –ü–æ—Ä—Ç 3000, —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞"
    echo "  uzws                      ${CHECK} –ü–æ—Ä—Ç 8080 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    echo ""
    echo -e "${CYAN}${BOLD}–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:${NC}"
    echo "  ${CHECK} –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME-—Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤"
    echo "  ${CHECK} –ó–∞—â–∏—Ç–∞ –æ—Ç directory traversal –∞—Ç–∞–∫"
    echo "  ${CHECK} –ö—Ä–∞—Å–∏–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—à–∏–±–æ–∫ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
    echo "  ${CHECK} –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
    echo "  ${CHECK} –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤"
    echo "  ${CHECK} –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º Linux —Å netcat"
    echo ""
    echo -e "${PURPLE}–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${YELLOW}Ctrl+C${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤–µ—Ä—Å–∏–∏
show_version() {
    echo -e "${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë   Uzbek Web Server (UzWS) v2.0          ‚ïë"
    echo "‚ïë   'Plov Edition' üá∫üáø                    ‚ïë"
    echo "‚ïë   –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ            ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "${CHECK} ${CYAN}–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ MIME-—Ç–∏–ø—ã: HTML, CSS, JS, JSON, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è${NC}"
    echo -e "${CHECK} ${CYAN}–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞ - –æ–¥–∏–Ω bash-—Å–∫—Ä–∏–ø—Ç!${NC}"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ "$1" == "--version" || "$1" == "-v" ]]; then
    show_version
    exit 0
fi

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
PORT="${1:-8080}"
DIR="${2:-.}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º netcat (nc)
if ! command -v nc &> /dev/null; then
    echo -e "${ERROR} ${RED}–û—à–∏–±–∫–∞: netcat (nc) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
    echo -e "${INFO} ${YELLOW}–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π:${NC}"
    echo "  sudo apt-get install netcat-openbsd"
    echo "  –∏–ª–∏"
    echo "  sudo yum install nc"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$DIR" ]; then
    echo -e "${ERROR} ${RED}–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è '$DIR' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!${NC}"
    echo -e "${INFO} ${YELLOW}–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é${NC}"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd "$DIR"

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞
echo -e "${GREEN}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë     Uzbek Web Server (UzWS) –∑–∞–ø—É—â–µ–Ω!             ‚ïë"
echo "‚ïë            –í–µ—Ä—Å–∏—è 2.0 'Plov Edition'             ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""
echo -e "${SERVER} ${CYAN}–°–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç:${NC} ${YELLOW}http://localhost:${PORT}${NC}"
echo -e "${CHECK} ${CYAN}–ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:${NC} ${YELLOW}$(pwd)${NC}"
echo -e "${CHECK} ${CYAN}–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:${NC}"
ls -la | grep "^-" | head -5 | while read line; do
    filename=$(echo "$line" | awk '{print $9}')
    echo -e "  ${GREEN}‚Üí${NC} $filename"
done
echo ""
echo -e "${WARN} ${YELLOW}–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ:${NC} ${RED}Ctrl+C${NC}"
echo -e "${INFO} ${BLUE}–ñ—É—Ä–Ω–∞–ª –∑–∞–ø—Ä–æ—Å–æ–≤:${NC}"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_request() {
    echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} ${CYAN}$1${NC} ${YELLOW}$2${NC} -> ${BLUE}$3${NC}"
}

# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É 403
create_403_page() {
    cat << EOF
HTTP/1.1 403 Forbidden
Server: UzWS/2.0 (Uzbek Web Server)
Content-Type: text/html; charset=utf-8
Connection: close

<!DOCTYPE html>
<html>
<head>
    <title>403 - –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .error-code {
            font-size: 8em;
            font-weight: bold;
            margin: 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }
        .message {
            font-size: 2em;
            margin: 20px 0;
        }
        .details {
            font-size: 1.2em;
            max-width: 600px;
            margin: 20px auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }
        .emoji {
            font-size: 4em;
            margin: 20px;
        }
        .server-info {
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="emoji">üö´</div>
    <h1 class="error-code">403</h1>
    <div class="message">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!</div>
    <div class="details">
        <p>Uzbek Web Server –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
        <p>–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç—Å—è.</p>
    </div>
    <div class="server-info">
        Uzbek Web Server v2.0 | üá∫üáø –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ
    </div>
</body>
</html>
EOF
}

# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É 404
create_404_page() {
    cat << EOF
HTTP/1.1 404 Not Found
Server: UzWS/2.0 (Uzbek Web Server)
Content-Type: text/html; charset=utf-8
Connection: close

<!DOCTYPE html>
<html>
<head>
    <title>404 - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .error-code {
            font-size: 8em;
            font-weight: bold;
            margin: 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }
        .message {
            font-size: 2em;
            margin: 20px 0;
        }
        .details {
            font-size: 1.2em;
            max-width: 600px;
            margin: 20px auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }
        .food-emoji {
            font-size: 4em;
            margin: 20px;
        }
        .uzbek-item {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
        }
        .server-info {
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="food-emoji">üçö</div>
    <h1 class="error-code">404</h1>
    <div class="message">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!</div>
    <div class="details">
        <p>–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ.</p>
        <p>–ü–æ–∫–∞ –≤—ã –∑–¥–µ—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–∑–±–µ–∫—Å–∫—É—é –∫—É—Ö–Ω—é:</p>
        <div>
            <span class="uzbek-item">üçö –ü–ª–æ–≤</span>
            <span class="uzbek-item">ü•ü –ú–∞–Ω—Ç—ã</span>
            <span class="uzbek-item">üç¢ –®–∞—à–ª—ã–∫</span>
            <span class="uzbek-item">üçû –õ–µ–ø–µ—à–∫–∞</span>
        </div>
    </div>
    <div class="server-info">
        Uzbek Web Server v2.0 | üá∫üáø –° –ª—é–±–æ–≤—å—é –∏–∑ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞
    </div>
</body>
</html>
EOF
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–µ—Ä–≤–µ—Ä–∞
while true; do
    {
        # –ß–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å
        read -r request
        method=$(echo "$request" | awk '{print $1}')
        path=$(echo "$request" | awk '{print $2}' | cut -d'?' -f1)
        
        # –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ª—ç—à
        path="${path#/}"
        [ -z "$path" ] && path="index.html"
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç directory traversal
        if [[ "$path" == *..* || "$path" == /* ]]; then
            log_request "$method" "$path" "403 Forbidden"
            create_403_page
            continue
        fi
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø
        case "$path" in
            *.html|*.htm)   mime="text/html; charset=utf-8" ;;
            *.css)          mime="text/css; charset=utf-8" ;;
            *.js)           mime="application/javascript; charset=utf-8" ;;
            *.json)         mime="application/json; charset=utf-8" ;;
            *.jpg|*.jpeg)   mime="image/jpeg" ;;
            *.png)          mime="image/png" ;;
            *.gif)          mime="image/gif" ;;
            *.svg)          mime="image/svg+xml" ;;
            *.ico)          mime="image/x-icon" ;;
            *.txt)          mime="text/plain; charset=utf-8" ;;
            *)              mime="application/octet-stream" ;;
        esac
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if [ -f "$path" ]; then
            size=$(stat -c%s "$path" 2>/dev/null || echo "0")
            log_request "$method" "$path" "200 OK"
            echo "HTTP/1.1 200 OK"
            echo "Server: UzWS/2.0 (Uzbek Web Server)"
            echo "Content-Type: $mime"
            echo "Content-Length: $size"
            echo "Connection: close"
            echo "X-Powered-By: Plov, Non –∏ Uzbek Tea"
            echo "X-Server: üá∫üáø Uzbek Web Server v2.0"
            echo ""
            cat "$path"
        else
            # 404 - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            log_request "$method" "$path" "404 Not Found"
            create_404_page
        fi
    } | nc -l -p "$PORT" -q 1 2>/dev/null || break
done

echo ""
echo -e "${INFO} ${YELLOW}–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
echo -e "${CHECK} ${GREEN}Uzbek Web Server - –≤—Å–µ–≥–¥–∞ –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º! üá∫üáø${NC}"
